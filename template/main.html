<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Illinois • Panel</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script defer src="/static/app.js"></script>
  <script>
    // Subscripción al estado de conexión del PLC
    let plcConnected = false;
    let plcIcon = null; // Se inicializará cuando el DOM esté listo
    let hasReceivedStatus = false; // Para saber si hemos recibido algún estado
    
    // Función para actualizar el estado visual del icono PLC
    function updatePLCConnectionStatus(connected, message = "") {
      plcConnected = connected;
      hasReceivedStatus = true; // Marcamos que hemos recibido un estado
      
      console.log(`[main] updatePLCConnectionStatus llamado: connected=${connected}, message="${message}"`);
      
      // Buscar el icono cada vez para asegurar que existe
      if (!plcIcon) {
        plcIcon = document.querySelector('.center-icons svg[title="Alimentador"]');
        console.log(`[main] Buscando icono PLC con selector '.center-icons svg[title="Alimentador"]':`, plcIcon);
      }
      
      if (plcIcon) {
        if (connected) {
          plcIcon.style.fill = "#dc2626"; // Rojo cuando está conectado
          console.log(`[main] ✅ PLC CONECTADO (rojo): ${message}`);
        } else {
          plcIcon.style.fill = "#4A0000"; // Bordeau muy oscuro cuando está desconectado
          console.log(`[main] ❌ PLC DESCONECTADO (bordeau oscuro): ${message}`);
        }
      } else {
        console.error('[main] No se pudo encontrar el icono del PLC');
        // Intentar encontrar todos los SVGs para debug
        const allSvgs = document.querySelectorAll('.center-icons svg');
        console.log('[main] SVGs encontrados en .center-icons:', allSvgs.length);
        allSvgs.forEach((svg, index) => {
          console.log(`[main] SVG ${index}: title="${svg.getAttribute('title')}"`);
        });
      }
    }
    
    // Función para resetear el estado (cuando no hay información)
    function resetPLCStatus() {
      hasReceivedStatus = false;
      if (plcIcon) {
        plcIcon.style.fill = "#666666"; // Gris cuando no hay información
        console.log('[main] PLC estado desconocido (gris)');
      }
    }
    
    // Función para suscribirse a eventos de conexión del PLC
    async function subscribeToPLCConnection() {
      try {
        console.log('[main] Iniciando subscripción a eventos PLC...');
        
        // Crear un EventSource para recibir eventos del PLC
        const eventSource = new EventSource('/api/plc/events');
        console.log('[main] EventSource creado');
        
        eventSource.onmessage = function(event) {
          try {
            console.log('[main] Evento recibido:', event.data);
            const data = JSON.parse(event.data);
            if (data.type === 'connection_status') {
              console.log('[main] Actualizando estado PLC:', data.connected, data.message);
              updatePLCConnectionStatus(data.connected, data.message);
            }
          } catch (error) {
            console.error('[main] Error procesando evento PLC:', error);
          }
        };
        
        eventSource.onerror = function(error) {
          console.error('[main] Error en EventSource PLC:', error);
          // Resetear estado cuando hay error en la conexión (no sabemos el estado real)
          resetPLCStatus();
        };
        
        // También verificar estado inicial
        console.log('[main] Verificando estado inicial del PLC...');
        const response = await fetch('/api/plc/status');
        const data = await response.json();
        console.log('[main] Respuesta estado inicial:', data);
        if (data.ok) {
          updatePLCConnectionStatus(data.status.connected, "Estado inicial");
        } else {
          console.warn('[main] No se pudo obtener estado inicial del PLC');
          resetPLCStatus();
        }
        
        // Timeout para detectar si no recibimos estado después de 10 segundos
        setTimeout(() => {
          if (!hasReceivedStatus) {
            console.warn('[main] Timeout: No se recibió estado del PLC después de 10 segundos');
            resetPLCStatus();
          }
        }, 10000);
        
      } catch (error) {
        console.error('[main] Error suscribiéndose a eventos PLC:', error);
        updatePLCConnectionStatus(false, "Error de suscripción");
      }
    }
    
    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[main] DOM cargado, inicializando subscripción PLC...');
      
      // Buscar el icono del PLC
      plcIcon = document.querySelector('.center-icons svg[title="Alimentador"]');
      if (plcIcon) {
        console.log('[main] Icono del PLC encontrado');
        // Inicializar en estado gris (desconocido)
        resetPLCStatus();
      } else {
        console.error('[main] No se pudo encontrar el icono del PLC');
      }
      
      // Iniciar subscripción
      subscribeToPLCConnection();
      
      // Configurar manejo de mensajes para navegación entre páginas
      setupPageNavigation();
    });

    // Función para manejar la navegación entre páginas
    function setupPageNavigation() {
      window.addEventListener('message', function(event) {
        console.log('[main] Mensaje recibido:', event.data);
        
        if (event.data.action === 'loadAlgorithmConfig') {
          console.log('[main] Cargando configuración de algoritmo:', event.data.algorithm);
          loadAlgorithmConfigPage(event.data.algorithm);
        } else if (event.data.action === 'navigateToDetection') {
          console.log('[main] Navegando de vuelta a detección');
          navigateBackToDetection();
        }
      });
    }

    // Función para navegar de vuelta a la página de detección
    function navigateBackToDetection() {
      const leftFrame = document.getElementById('leftFrame');
      if (leftFrame) {
        leftFrame.src = '/template/filter_config.html';
        
        // Esperar a que se cargue la página y activar la pestaña de detección
        leftFrame.onload = function() {
          leftFrame.contentWindow.postMessage({
            action: 'switchToDetectionTab'
          }, '*');
        };
      }
    }

    // Función para cargar la página de configuración de algoritmos
    function loadAlgorithmConfigPage(algorithm) {
      const leftFrame = document.getElementById('leftFrame');
      if (leftFrame) {
        leftFrame.src = '/template/algorithm_config.html';
        
        // Esperar a que se cargue la página y enviar el algoritmo
        leftFrame.onload = function() {
          leftFrame.contentWindow.postMessage({
            action: 'setAlgorithm',
            algorithm: algorithm
          }, '*');
        };
      }
    }
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="/static/logo.png" alt="Illinois" class="logo">
    </div>

    <div class="center-icons" style="display: flex; align-items: center; gap: 24px; position: absolute; left: 50%; transform: translateX(-50%);">
      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" fill="#666666" viewBox="0 0 640 640" title="Alimentador" style="cursor: pointer;">
        <path d="M160 144C151.2 144 144 151.2 144 160L144 322C149.1 320.7 154.5 320 160 320L480 320C485.5 320 490.9 320.7 496 322L496 160C496 151.2 488.8 144 480 144L160 144zM144 384L144 480C144 488.8 151.2 496 160 496L480 496C488.8 496 496 488.8 496 480L496 384C496 375.2 488.8 368 480 368L160 368C151.2 368 144 375.2 144 384zM96 384L96 160C96 124.7 124.7 96 160 96L480 96C515.3 96 544 124.7 544 160L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 384zM312 432C312 418.7 322.7 408 336 408C349.3 408 360 418.7 360 432C360 445.3 349.3 456 336 456C322.7 456 312 445.3 312 432zM432 408C445.3 408 456 418.7 456 432C456 445.3 445.3 456 432 456C418.7 456 408 445.3 408 432C408 418.7 418.7 408 432 408z"/>
      </svg>
      
      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" fill="#666666" viewBox="0 0 640 640" title="Vision" style="cursor: pointer;">
        <path d="M320 96C239.2 96 174.5 132.8 127.4 176.6C80.6 220.1 49.3 272 34.4 307.7C31.1 315.6 31.1 324.4 34.4 332.3C49.3 368 80.6 420 127.4 463.4C174.5 507.1 239.2 544 320 544C400.8 544 465.5 507.2 512.6 463.4C559.4 419.9 590.7 368 605.6 332.3C608.9 324.4 608.9 315.6 605.6 307.7C590.7 272 559.4 220 512.6 176.6C465.5 132.9 400.8 96 320 96zM176 320C176 240.5 240.5 176 320 176C399.5 176 464 240.5 464 320C464 399.5 399.5 464 320 464C240.5 464 176 399.5 176 320zM320 256C320 291.3 291.3 320 256 320C244.5 320 233.7 317 224.3 311.6C223.3 322.5 224.2 333.7 227.2 344.8C240.9 396 293.6 426.4 344.8 412.7C396 399 426.4 346.3 412.7 295.1C400.5 249.4 357.2 220.3 311.6 224.3C316.9 233.6 320 244.4 320 256z"/>
      </svg>
      
      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" fill="#666666" viewBox="0 0 640 640" title="Robot" style="cursor: pointer;">
        <path d="M352 64C352 46.3 337.7 32 320 32C302.3 32 288 46.3 288 64L288 128L192 128C139 128 96 171 96 224L96 448C96 501 139 544 192 544L448 544C501 544 544 501 544 448L544 224C544 171 501 128 448 128L352 128L352 64zM160 432C160 418.7 170.7 408 184 408L216 408C229.3 408 240 418.7 240 432C240 445.3 229.3 456 216 456L184 456C170.7 456 160 445.3 160 432zM280 432C280 418.7 290.7 408 304 408L336 408C349.3 408 360 418.7 360 432C360 445.3 349.3 456 336 456L304 456C290.7 456 280 445.3 280 432zM400 432C400 418.7 410.7 408 424 408L456 408C469.3 408 480 418.7 480 432C480 445.3 469.3 456 456 456L424 456C410.7 456 400 445.3 400 432zM224 240C250.5 240 272 261.5 272 288C272 314.5 250.5 336 224 336C197.5 336 176 314.5 176 288C176 261.5 197.5 240 224 240zM368 288C368 261.5 389.5 240 416 240C442.5 240 464 261.5 464 288C464 314.5 442.5 336 416 336C389.5 336 368 261.5 368 288zM64 288C64 270.3 49.7 256 32 256C14.3 256 0 270.3 0 288L0 384C0 401.7 14.3 416 32 416C49.7 416 64 401.7 64 384L64 288zM608 256C590.3 256 576 270.3 576 288L576 384C576 401.7 590.3 416 608 416C625.7 416 640 401.7 640 384L640 288C640 270.3 625.7 256 608 256z"/>
      </svg>
    </div>

    <nav class="actions" aria-label="Navegación">
      <button class="navbtn btn-transparent" data-page="control" title="Ir a Control" aria-current="page">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16">
          <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"/>
        </svg>
      </button>
      
    </nav>
    
    <div class="red-divider"></div>
  </header>

  <main class="split">
    <section class="pane left">
      <iframe id="leftFrame" src="/template/control.html" title="Panel izquierdo" class="pane-frame" loading="eager"></iframe>
    </section>
    <section class="pane right">
      <iframe src="/template/dashboard.html" title="Dashboard" class="pane-frame" loading="eager"></iframe>
    </section>
  </main>
</body>
</html>