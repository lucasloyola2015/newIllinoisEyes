<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC LOGO - Control</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="wrap">
        <h1 class="page-header">PLC LOGO - Control</h1>

        <div class="card">
            <h2 class="text-lg font-semibold">Estado de Conexión</h2>
            <div class="cfg-row" style="margin-top:8px;">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="connectionLed" class="led led-rojo led-md"></div>
                        <span id="connectionStatus">Desconectado</span>
                    </div>
                    <span class="text-sm text-muted">Conexión automática activa</span>
                </div>
                <div class="cfg-row" style="margin-top:8px;">
                    <button id="btnReadAll" class="btn btn-sm" onclick="readAll()">
                        Leer Todo
                    </button>
                    <button id="btnReadOutputs" class="btn btn-sm" onclick="readOutputs()">
                        Leer Salidas
                    </button>
                    <button id="btnReadMarks" class="btn btn-sm" onclick="readMarks()">
                        Leer Marcas
                    </button>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 24px;">
            <h2 class="text-lg font-semibold">Salidas Físicas (Q1-Q4)</h2>
            <div class="grid-fill-4" style="margin-top:8px;">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="q1">
                    <label for="q1" class="font-medium">Q1</label>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="q2">
                    <label for="q2" class="font-medium">Q2</label>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="q3">
                    <label for="q3" class="font-medium">Q3</label>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="q4">
                    <label for="q4" class="font-medium">Q4</label>
                </div>
            </div>
            
        </div>

        <div class="card" style="margin-top: 24px;">
            <h2 class="text-lg font-semibold">Marcas (M1-M8)</h2>
            <div class="grid-fill-4" style="margin-top:8px;">
                <div class="flex items-center gap-3"><input type="checkbox" id="m1"><label for="m1" class="font-medium">M1</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m2"><label for="m2" class="font-medium">M2</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m3"><label for="m3" class="font-medium">M3</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m4"><label for="m4" class="font-medium">M4</label></div>
            </div>
            <div class="grid-fill-4" style="margin-top: var(--space-lg);">
                <div class="flex items-center gap-3"><input type="checkbox" id="m5"><label for="m5" class="font-medium">M5</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m6"><label for="m6" class="font-medium">M6</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m7"><label for="m7" class="font-medium">M7</label></div>
                <div class="flex items-center gap-3"><input type="checkbox" id="m8"><label for="m8" class="font-medium">M8</label></div>
            </div>
            
        </div>

        <div class="card" style="margin-top: 24px;">
            <div>
                <h2 class="text-lg font-semibold">Entradas (I1-I8)</h2>
            </div>
        
            <div class="grid-fill-4" style="margin-top:8px;">
                <div class="flex items-center gap-3"><div id="i1Led" class="led led-gris led-md"></div><label class="font-medium">I1</label></div>
                <div class="flex items-center gap-3"><div id="i2Led" class="led led-gris led-md"></div><label class="font-medium">I2</label></div>
                <div class="flex items-center gap-3"><div id="i3Led" class="led led-gris led-md"></div><label class="font-medium">I3</label></div>
                <div class="flex items-center gap-3"><div id="i4Led" class="led led-gris led-md"></div><label class="font-medium">I4</label></div>
            </div>
        
            <div class="grid-fill-4" style="margin-top: var(--space-lg);">
                <div class="flex items-center gap-3"><div id="i5Led" class="led led-gris led-md"></div><label class="font-medium">I5</label></div>
                <div class="flex items-center gap-3"><div id="i6Led" class="led led-gris led-md"></div><label class="font-medium">I6</label></div>
                <div class="flex items-center gap-3"><div id="i7Led" class="led led-gris led-md"></div><label class="font-medium">I7</label></div>
                <div class="flex items-center gap-3"><div id="i8Led" class="led led-gris led-md"></div><label class="font-medium">I8</label></div>
            </div>
        
            
        </div>
    </div>

    <script src="/static/common.js"></script>
    <script>
      // Tu JavaScript permanece exactamente igual. No necesita cambios.

      // Variables globales
      let plcConnected = false;

             // Elementos del DOM
       const connectionLed = document.getElementById('connectionLed');
       const connectionStatus = document.getElementById('connectionStatus');
       const btnReadAll = document.getElementById('btnReadAll');

      // Checkboxes de salidas
      const q1 = document.getElementById('q1');
      const q2 = document.getElementById('q2');
      const q3 = document.getElementById('q3');
      const q4 = document.getElementById('q4');

      // Checkboxes de marcas
      const m1 = document.getElementById('m1');
      const m2 = document.getElementById('m2');
      const m3 = document.getElementById('m3');
      const m4 = document.getElementById('m4');
      const m5 = document.getElementById('m5');
      const m6 = document.getElementById('m6');
      const m7 = document.getElementById('m7');
      const m8 = document.getElementById('m8');

      // LEDs de entradas
      const i1Led = document.getElementById('i1Led');
      const i2Led = document.getElementById('i2Led');
      const i3Led = document.getElementById('i3Led');
      const i4Led = document.getElementById('i4Led');
      const i5Led = document.getElementById('i5Led');
      const i6Led = document.getElementById('i6Led');
      const i7Led = document.getElementById('i7Led');
      const i8Led = document.getElementById('i8Led');

      // Función para actualizar estado de conexión
      function updateConnectionStatus(connected) {
          plcConnected = connected;
          if (connected) {
              connectionLed.className = 'led led-verde led-md';
              connectionStatus.textContent = 'Conectado';
          } else {
              connectionLed.className = 'led led-rojo led-md';
              connectionStatus.textContent = 'Desconectado';
          }
      }

      // Función para actualizar LED de entrada
      function updateInputLed(ledElement, state) {
          if (state) {
              ledElement.className = 'led led-verde led-md';
          } else {
              ledElement.className = 'led led-gris led-md';
          }
      }

      // Función para consultar estado del PLC (solo para estado inicial)
      async function checkPLCStatus() {
          try {
              const response = await Common.fetchWithTimeout('/api/plc/status', {
                  method: 'GET',
                  headers: { 'Content-Type': 'application/json' }
              });
              const data = await response.json();
              if (data.ok) {
                  updateConnectionStatus(data.status.connected);
                  
                  // Si está conectado, leer todos los valores iniciales
                  if (data.status.connected) {
                      console.log('PLC conectado - leyendo valores iniciales...');
                      setTimeout(readAll, 500);
                  }
              } else {
                  updateConnectionStatus(false);
              }
          } catch (error) {
              console.error('Error consultando estado PLC:', error);
              updateConnectionStatus(false);
          }
      }

             // Función para escribir salida
       async function writeOutput(address, valor) {
           if (!plcConnected) {
               alert('PLC no conectado');
               return;
           }
           try {
               const response = await Common.fetchWithTimeout('/api/plc/write', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       address: address,
                       valor: valor
                   })
               });
               const data = await response.json();
               if (!data.ok) {
                   alert('Error escribiendo ' + address + ': ' + data.message);
               }
           } catch (error) {
               console.error('Error escribiendo salida:', error);
               alert('Error de conexión: ' + error.message);
           }
       }

      

             // Función para leer entradas
       async function readAll() {
           if (!plcConnected) {
               alert('PLC no conectado');
               return;
           }
           
           // Función interna para hacer la lectura con retry
           async function attemptRead(retryCount = 0) {
               try {
                   const response = await Common.fetchWithTimeout('/api/plc/read_all', {
                       method: 'POST',
                       headers: { 'Content-Type': 'application/json' }
                   });
                   const data = await response.json();
                   if (data.ok) {
                       // Actualizar LEDs de entradas
                       updateInputLed(i1Led, data.inputs[0]);
                       updateInputLed(i2Led, data.inputs[1]);
                       updateInputLed(i3Led, data.inputs[2]);
                       updateInputLed(i4Led, data.inputs[3]);
                       updateInputLed(i5Led, data.inputs[4]);
                       updateInputLed(i6Led, data.inputs[5]);
                       updateInputLed(i7Led, data.inputs[6]);
                       updateInputLed(i8Led, data.inputs[7]);
                       
                       // Actualizar checkboxes de salidas (Q1-Q4)
                       q1.checked = data.outputs[0];
                       q2.checked = data.outputs[1];
                       q3.checked = data.outputs[2];
                       q4.checked = data.outputs[3];
                       
                       // Actualizar checkboxes de marcas (M1-M8)
                       m1.checked = data.marks[0];
                       m2.checked = data.marks[1];
                       m3.checked = data.marks[2];
                       m4.checked = data.marks[3];
                       m5.checked = data.marks[4];
                       m6.checked = data.marks[5];
                       m7.checked = data.marks[6];
                       m8.checked = data.marks[7];
                       
                       console.log('Datos leídos:', {inputs: data.inputs, outputs: data.outputs, marks: data.marks.slice(0,8)});
                       
                       // Si fue un retry exitoso, no mostrar el error inicial
                       if (retryCount > 0) {
                           console.log('Lectura exitosa después de retry');
                       }
                   } else {
                       // Si es el primer intento y falla, hacer retry
                       if (retryCount === 0) {
                           console.log('Primera lectura falló, intentando retry...');
                           setTimeout(() => attemptRead(1), 100);
                           return;
                       }
                       // Si el retry también falla, mostrar error
                       console.error('Error leyendo datos después de retry:', data.message);
                   }
               } catch (error) {
                   // Si es el primer intento y hay error de conexión, hacer retry
                   if (retryCount === 0) {
                       console.log('Error de conexión en primera lectura, intentando retry...');
                       setTimeout(() => attemptRead(1), 100);
                       return;
                   }
                   // Si el retry también falla, mostrar error
                   console.error('Error de conexión después de retry:', error);
               }
           }
           
           // Iniciar la lectura
           attemptRead();
       }

       // Función para leer solo salidas
       async function readOutputs() {
           if (!plcConnected) {
               alert('PLC no conectado');
               return;
           }
           try {
               const response = await Common.fetchWithTimeout('/api/plc/read_outputs', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' }
               });
               const data = await response.json();
               if (data.ok) {
                   // Actualizar checkboxes de salidas (Q1-Q4)
                   q1.checked = data.outputs[0];
                   q2.checked = data.outputs[1];
                   q3.checked = data.outputs[2];
                   q4.checked = data.outputs[3];
                   console.log('Salidas leídas:', data.outputs);
               } else {
                   alert('Error leyendo salidas: ' + data.message);
               }
           } catch (error) {
               console.error('Error leyendo salidas:', error);
               alert('Error de conexión: ' + error.message);
           }
       }

       // Función para leer solo marcas
       async function readMarks() {
           if (!plcConnected) {
               alert('PLC no conectado');
               return;
           }
           try {
               const response = await Common.fetchWithTimeout('/api/plc/read_marks', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' }
               });
               const data = await response.json();
               if (data.ok) {
                   // Actualizar checkboxes de marcas (M1-M8)
                   m1.checked = data.marks[0];
                   m2.checked = data.marks[1];
                   m3.checked = data.marks[2];
                   m4.checked = data.marks[3];
                   m5.checked = data.marks[4];
                   m6.checked = data.marks[5];
                   m7.checked = data.marks[6];
                   m8.checked = data.marks[7];
                   console.log('Marcas leídas:', data.marks.slice(0,8));
               } else {
                   alert('Error leyendo marcas: ' + data.message);
               }
           } catch (error) {
               console.error('Error leyendo marcas:', error);
               alert('Error de conexión: ' + error.message);
           }
       }

             // Event listeners para botones
       btnReadAll.addEventListener('click', readAll);
       document.getElementById('btnReadOutputs').addEventListener('click', readOutputs);
       document.getElementById('btnReadMarks').addEventListener('click', readMarks);

             // Event listeners para checkboxes de salidas Q
       q1.addEventListener('change', (e) => writeOutput('Q1', e.target.checked));
       q2.addEventListener('change', (e) => writeOutput('Q2', e.target.checked));
       q3.addEventListener('change', (e) => writeOutput('Q3', e.target.checked));
       q4.addEventListener('change', (e) => writeOutput('Q4', e.target.checked));

       // Event listeners para checkboxes de marcas M
       m1.addEventListener('change', (e) => writeOutput('M1', e.target.checked));
       m2.addEventListener('change', (e) => writeOutput('M2', e.target.checked));
       m3.addEventListener('change', (e) => writeOutput('M3', e.target.checked));
       m4.addEventListener('change', (e) => writeOutput('M4', e.target.checked));
       m5.addEventListener('change', (e) => writeOutput('M5', e.target.checked));
       m6.addEventListener('change', (e) => writeOutput('M6', e.target.checked));
       m7.addEventListener('change', (e) => writeOutput('M7', e.target.checked));
       m8.addEventListener('change', (e) => writeOutput('M8', e.target.checked));

      // Inicializar
      updateConnectionStatus(false);
      checkPLCStatus();
      console.log('Página PLC LOGO cargada - Thread de conexión automática activo');
    </script>
</body>
</html>